<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomie - User Agreement</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3Cline x1='16' y1='13' x2='8' y2='13'%3E%3C/line%3E%3Cline x1='16' y1='17' x2='8' y2='17'%3E%3C/line%3E%3Cline x1='10' y1='9' x2='8' y2='9'%3E%3C/line%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Language Switcher */
        .lang-switcher {
            position: fixed;
            z-index: 50;
            transition: all 0.3s ease;
        }

        /* Desktop: Top Right */
        @media (min-width: 1024px) {
            .lang-switcher {
                top: 1.5rem;
                right: 2rem;
            }
        }

        /* Mobile: Bottom Right */
        @media (max-width: 1023px) {
            .lang-switcher {
                bottom: 1.5rem;
                right: 1.5rem;
                top: auto;
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active TOC link */
        .toc-active {
            color: #4f46e5 !important;
            border-left-color: #4f46e5 !important;
            background-color: #eff6ff;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen flex flex-col">

    <!-- Language Switcher Component -->
    <div class="lang-switcher">
        <div class="relative inline-block text-left">
            <div>
                <!-- Added event parameter to toggleDropdown to manage propagation if needed, though simple click is fine -->
                <button type="button" onclick="toggleDropdown(event)" class="group inline-flex justify-center w-full rounded-full border border-gray-200 shadow-lg shadow-indigo-500/10 px-4 py-3 bg-white text-sm font-semibold text-gray-700 hover:bg-gray-50 hover:text-indigo-600 focus:outline-none transition-all duration-200" id="menu-button" aria-expanded="true" aria-haspopup="true">
                    <i class="fas fa-globe mr-2 text-indigo-500 group-hover:rotate-12 transition-transform"></i>
                    <span id="current-lang-label">Русский</span>
                    <i class="fas fa-chevron-down ml-2 -mr-1 h-4 w-4 opacity-50"></i>
                </button>
            </div>
            <!-- Removed complex transition classes that were causing issues when toggled -->
            <div id="lang-dropdown" class="hidden origin-top-right absolute right-0 bottom-14 lg:bottom-auto lg:top-12 mt-2 w-56 rounded-xl shadow-xl bg-white ring-1 ring-black ring-opacity-5 focus:outline-none max-h-80 overflow-y-auto" role="menu">
                <div class="py-2" role="none">
                    <!-- Languages injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex-grow container mx-auto px-4 py-8 lg:py-12 max-w-7xl">
        <div class="lg:grid lg:grid-cols-12 lg:gap-10 items-start">
            
            <!-- Left Sidebar (Table of Contents) - Desktop Only -->
            <aside class="hidden lg:block lg:col-span-3 sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto pr-2">
                <nav class="space-y-1" id="toc-desktop">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-3">Навигация</h3>
                    <!-- Links injected by JS -->
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="lg:col-span-9 relative">
                <!-- Header Section -->
                <div id="header-area" class="mb-8 fade-in text-center lg:text-left">
                    <!-- Title/Date injected here -->
                </div>

                <!-- Content Blocks -->
                <div id="content-area" class="space-y-6 fade-in">
                    <!-- Cards injected here -->
                    <div class="flex justify-center items-center h-64">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-auto">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-400 text-sm">
                &copy; 2026 Roomie. <span id="footer-rights">All rights reserved.</span>
            </p>
        </div>
    </footer>

    <script>
        // --- 1. Data Source ---
        const contentData = {
            'ru': {
                name: "Русский",
                dir: "ltr",
                tocTitle: "Содержание",
                title: "ПОЛЬЗОВАТЕЛЬСКОЕ СОГЛАШЕНИЕ",
                subtitle: "ПЛАТФОРМА ROOMIE",
                date: "Обновлено: 15 января 2026 г.",
                body: `
                    <h2>1. ОБЩИЕ ПОЛОЖЕНИЯ</h2>
                    <p><strong>1.1.</strong> Настоящее Соглашение регулирует порядок использования сайта, мобильного приложения и всех сопутствующих сервисов Roomie (далее — «Сервис»).</p>
                    <p><strong>1.2. Публичная оферта и отдельные согласия</strong></p>
                    <p>Настоящий документ является публичной офертой (предложением заключить договор на условиях, изложенных в Соглашении). Акцептом оферты является совершение Пользователем/Гостем действий, свидетельствующих о принятии условий Соглашения, включая фактическое использование Сервиса (например, просмотр страниц, использование функций, регистрация).</p>
                    <p>Акцепт Соглашения не означает автоматическое предоставление явного согласия (Consent) на обработку персональных данных для целей, где по GDPR требуется согласие (маркетинговые cookie, реклама). Там, где требуется согласие, оно запрашивается отдельно и может быть отозвано в любой момент.</p>
                    <p><strong>1.3. Изменение условий</strong></p>
                    <p>Администрация вправе изменять условия Соглашения. При существенных изменениях Администрация уведомляет Пользователей. Новая редакция вступает в силу с даты, указанной в уведомлении.</p>

                    <h2>2. ПРАВА И ОБЯЗАННОСТИ ГОСТЯ</h2>
                    <p><strong>2.1. Ограниченная лицензия</strong></p>
                    <p>Администрация предоставляет Гостю неисключительное право на просмотр контента исключительно для личных некоммерческих целей.</p>
                    <p><strong>2.2. Запрет на скрейпинг</strong></p>
                    <p>Гостю запрещается использовать автоматизированные средства (боты, парсеры) для сбора данных без разрешения. Нарушение ведет к блокировке доступа и юридическим мерам.</p>
                    <p><strong>2.3. Конфиденциальность</strong></p>
                    <p>Гость осознает, что его действия могут фиксироваться (логи, аналитика). Обработка регулируется Политикой конфиденциальности.</p>

                    <h2>3. COOKIE И ТРЕКИНГ</h2>
                    <p><strong>3.1. Принципы</strong></p>
                    <p>Roomie использует cookie для улучшения опыта, безопасности и аналитики.</p>
                    <p><strong>3.2. Типы cookie</strong></p>
                    <ul>
                        <li><strong>Строго необходимые:</strong> Технически нужны для работы (сессии, безопасность).</li>
                        <li><strong>Функциональные:</strong> Запоминают настройки (язык, валюта).</li>
                        <li><strong>Аналитические/Маркетинговые:</strong> Только с вашего согласия (Opt-In).</li>
                    </ul>
                    <p><strong>3.3. Управление согласием</strong></p>
                    <p>Вы можете изменить настройки в панели «Privacy Settings». Согласие запрашивается повторно каждые 12 месяцев.</p>

                    <h2>4. ПЕРСОНАЛЬНЫЕ ДАННЫЕ</h2>
                    <p><strong>4.1. Связь с Политикой</strong></p>
                    <p>В вопросах данных приоритет имеет Политика конфиденциальности Roomie.</p>
                    <p><strong>4.2. Трансграничная передача</strong></p>
                    <p>Данные могут передаваться вне ЕС с использованием стандартных договорных условий (SCC) и мер защиты.</p>
                    <p><strong>4.3. Хранение</strong></p>
                    <ul>
                        <li>Логи гостей: до 12 месяцев.</li>
                        <li>Маркетинговые данные: удаляются по достижении целей или неактивности (обычно ~13 месяцев).</li>
                    </ul>
                    <p><strong>4.4. Ваши права (GDPR)</strong></p>
                    <p>Доступ, исправление, удаление, переносимость данных. Запросы направляйте на legal@hotelmol.com.</p>
                    <p><strong>4.5. Контакт (DPO)</strong></p>
                    <p><a href="mailto:legal@hotelmol.com" class="text-indigo-600 font-medium hover:underline">legal@hotelmol.com</a></p>

                    <h2>5. DISCLAIMER (ОТКАЗ)</h2>
                    <p><strong>5.1.</strong> Сервис предоставляется «как есть» (as is). Мы не гарантируем работу на всех устройствах.</p>
                    <p><strong>5.2.</strong> Мы принимаем меры защиты, но не несем ответственности за сбои вне нашего контроля.</p>

                    <h2>6. ПРАВА АДМИНИСТРАЦИИ</h2>
                    <p><strong>6.1.</strong> Мы защищаем Сервис от злоупотреблений.</p>
                    <p><strong>6.2.</strong> Мы можем менять функционал по техническим или юридическим причинам.</p>
                    <p><strong>6.3.</strong> Мы модерируем контент и можем ограничивать доступ нарушителям.</p>

                    <h2>7. ОТВЕТСТВЕННОСТЬ</h2>
                    <p><strong>7.1.</strong> Пользователь отвечает за свои действия и контент.</p>
                    <p><strong>7.2.</strong> Мы не отвечаем за действия третьих лиц и внешние ссылки.</p>
                    <p><strong>7.3.</strong> Форс-мажор освобождает стороны от ответственности.</p>

                    <h2>8. СПОРЫ И ПРАВО</h2>
                    <p><strong>8.1.</strong> Применяется право юрисдикции Администрации (если иное не требует закон о потребителях).</p>
                    <p><strong>8.2.</strong> Обязателен досудебный порядок (ответ на претензию — 10 дней).</p>

                    <h2>9. СРОК ДЕЙСТВИЯ</h2>
                    <p>Соглашение действует до удаления аккаунта. Положения об ответственности сохраняют силу после.</p>

                    <h2>10. РЕКВИЗИТЫ</h2>
                    <p><strong>ТОВ "hotelmol"</strong><br>Воздвиженская, 40<br><a href="mailto:legal@hotelmol.com" class="text-indigo-600 font-medium hover:underline">legal@hotelmol.com</a></p>
                `
            },
            'en': {
                name: "English",
                dir: "ltr",
                tocTitle: "Contents",
                title: "USER AGREEMENT",
                subtitle: "ROOMIE PLATFORM",
                date: "Last Updated: January 15, 2026",
                body: `
                    <h2>1. GENERAL PROVISIONS</h2>
                    <p><strong>1.1.</strong> This Agreement regulates the use of the Roomie website, mobile application, and services.</p>
                    <p><strong>1.2. Public Offer</strong></p>
                    <p>This is a public offer. Acceptance includes actual use of the Service (browsing, registration).</p>
                    <p>Acceptance does not imply automatic GDPR consent for marketing. Consent is requested separately and can be withdrawn.</p>
                    <p><strong>1.3. Changes</strong></p>
                    <p>We may amend this Agreement. Significant changes will be notified. Continued use implies acceptance.</p>

                    <h2>2. GUEST RIGHTS</h2>
                    <p><strong>2.1. Limited License</strong></p>
                    <p>Non-exclusive right to view content for personal non-commercial use only.</p>
                    <p><strong>2.2. No Scraping</strong></p>
                    <p>Automated data collection (bots, scrapers) is strictly prohibited without permission.</p>
                    <p><strong>2.3. Privacy</strong></p>
                    <p>Guest actions may be logged. Processing is governed by our Privacy Policy.</p>

                    <h2>3. COOKIES & TRACKING</h2>
                    <p><strong>3.1. Usage</strong></p>
                    <p>We use cookies for security, functionality, and analytics.</p>
                    <p><strong>3.2. Types</strong></p>
                    <ul>
                        <li><strong>Strictly Necessary:</strong> Essential for operation.</li>
                        <li><strong>Functional:</strong> Preferences (language, currency).</li>
                        <li><strong>Marketing:</strong> Only with Opt-In consent.</li>
                    </ul>
                    <p><strong>3.3. Control</strong></p>
                    <p>Manage via "Privacy Settings". Consent re-requested every 12 months.</p>

                    <h2>4. DATA PROTECTION</h2>
                    <p><strong>4.1. Policy Priority</strong></p>
                    <p>The Privacy Policy takes precedence for data issues.</p>
                    <p><strong>4.2. Transfers</strong></p>
                    <p>Data may be transferred globally using standard contractual clauses (SCCs) for protection.</p>
                    <p><strong>4.3. Retention</strong></p>
                    <ul>
                        <li>Guest logs: ~12 months.</li>
                        <li>Marketing data: Deleted upon goal achievement or inactivity.</li>
                    </ul>
                    <p><strong>4.4. GDPR Rights</strong></p>
                    <p>Access, rectification, erasure. Contact legal@hotelmol.com.</p>

                    <h2>5. DISCLAIMER</h2>
                    <p><strong>5.1.</strong> Service is provided "as is".</p>
                    <p><strong>5.2.</strong> We are not liable for failures beyond reasonable control.</p>

                    <h2>6. ADMINISTRATION RIGHTS</h2>
                    <p>We may modify the Service, moderate content, and restrict access for violations.</p>

                    <h2>7. LIABILITY</h2>
                    <p>Users are responsible for their content. We are not liable for third-party actions.</p>

                    <h2>8. DISPUTES</h2>
                    <p>Governed by Administration's jurisdiction. Mandatory pre-trial settlement (10 days).</p>

                    <h2>9. TERMINATION</h2>
                    <p>Valid until account deletion. Liability clauses survive termination.</p>

                    <h2>10. CONTACTS</h2>
                    <p><strong>LLC "hotelmol"</strong><br>Vozdvizhenskaya, 40<br><a href="mailto:legal@hotelmol.com">legal@hotelmol.com</a></p>
                `
            },
            // Generated placehoder languages
            'zh': { name: "中文 (Mandarin)", dir: "ltr", title: "用户协议", subtitle: "ROOMIE 平台", date: "2026年1月15日", body: null },
            'es': { name: "Español", dir: "ltr", title: "ACUERDO DE USUARIO", subtitle: "PLATAFORMA ROOMIE", date: "15 de enero de 2026", body: null },
            'fr': { name: "Français", dir: "ltr", title: "ACCORD D'UTILISATEUR", subtitle: "PLATEFORME ROOMIE", date: "15 janvier 2026", body: null },
            'pt': { name: "Português", dir: "ltr", title: "ACORDO DE USUÁRIO", subtitle: "PLATAFORMA ROOMIE", date: "15 de janeiro de 2026", body: null },
            'de': { name: "Deutsch", dir: "ltr", title: "NUTZERVEREINBARUNG", subtitle: "PLATTFORM ROOMIE", date: "15. Januar 2026", body: null },
            'ja': { name: "日本語", dir: "ltr", title: "ユーザー契約", subtitle: "ROOMIEプラットフォーム", date: "2026年1月15日", body: null },
            'zh-HK': { name: "廣東話 (Cantonese)", dir: "ltr", title: "用戶協議", subtitle: "ROOMIE 平台", date: "2026年1月15日", body: null },
            'hi': { name: "हिन्दी (Hindi)", dir: "ltr", title: "उपयोगकर्ता समझौता", subtitle: "ROOMIE प्लेटफ़ॉर्म", date: "15 जनवरी 2026", body: null },
            'bn': { name: "বাংলা (Bengali)", dir: "ltr", title: "ব্যবহারকারী চুক্তি", subtitle: "ROOMIE প্ল্যাটফর্ম", date: "15 জানুয়ারী 2026", body: null },
            'ar': { name: "العربية", dir: "rtl", title: "اتفاقية المستخدم", subtitle: "منصة ROOMIE", date: "15 يناير 2026", body: null },
            'id': { name: "Bahasa Indonesia", dir: "ltr", title: "PERJANJIAN PENGGUNA", subtitle: "PLATFORM ROOMIE", date: "15 Januari 2026", body: null },
            'vi': { name: "Tiếng Việt", dir: "ltr", title: "THỎA THUẬN NGƯỜI DÙNG", subtitle: "NỀN TẢNG ROOMIE", date: "15 tháng 1 năm 2026", body: null },
            'tr': { name: "Türkçe", dir: "ltr", title: "KULLANICI SÖZLEŞMESİ", subtitle: "ROOMIE PLATFORMU", date: "15 Ocak 2026", body: null },
            'ko': { name: "한국어", dir: "ltr", title: "사용자 계약", subtitle: "ROOMIE 플랫폼", date: "2026년 1월 15일", body: null },
            'pl': { name: "Polski", dir: "ltr", title: "UMOWA UŻYTKOWNIKA", subtitle: "PLATFORMA ROOMIE", date: "15 stycznia 2026", body: null }
        };

        // --- 2. Logic & Rendering ---

        const langDropdown = document.getElementById('lang-dropdown');
        const langLabel = document.getElementById('current-lang-label');
        const headerArea = document.getElementById('header-area');
        const contentArea = document.getElementById('content-area');
        const tocContainer = document.getElementById('toc-desktop');

        // Dropdown Logic
        const dropdownList = langDropdown.querySelector('div');
        Object.keys(contentData).forEach(lang => {
            const btn = document.createElement('button');
            btn.className = "text-gray-700 block px-4 py-2.5 text-sm w-full text-left hover:bg-indigo-50 hover:text-indigo-700 transition-colors";
            btn.textContent = contentData[lang].name;
            btn.onclick = () => setLanguage(lang);
            dropdownList.appendChild(btn);
        });

        function toggleDropdown(event) {
            if (event) event.stopPropagation();
            langDropdown.classList.toggle('hidden');
        }

        window.onclick = function(event) {
            // Updated to be more robust: close if clicking anywhere except inside the button or dropdown itself
            if (!event.target.closest('#menu-button') && !event.target.closest('#lang-dropdown')) {
                if (!langDropdown.classList.contains('hidden')) {
                    langDropdown.classList.add('hidden');
                }
            }
        }

        // --- Core Rendering Function ---
        function setLanguage(langCode) {
            // Fallback logic
            if (!contentData[langCode]) {
                const prefix = langCode.split('-')[0];
                langCode = contentData[prefix] ? prefix : 'en';
            }
            const data = contentData[langCode];
            const isDemo = !data.body;
            const bodyContent = isDemo ? contentData['en'].body : data.body;
            const isRTL = data.dir === 'rtl';

            // 1. Update Globals
            document.documentElement.lang = langCode;
            document.body.dir = data.dir;
            langLabel.textContent = data.name;

            // 2. Render Header
            headerArea.innerHTML = `
                <div class="inline-block px-3 py-1 mb-4 text-xs font-semibold tracking-wider text-indigo-500 uppercase bg-indigo-50 rounded-full">
                    Legal Document
                </div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight mb-2">
                    ${data.title}
                </h1>
                <p class="text-xl text-gray-500 font-medium mb-6">${data.subtitle}</p>
                <div class="flex items-center justify-center lg:justify-start space-x-2 text-sm text-gray-400">
                    <i class="far fa-clock"></i>
                    <span>${data.date}</span>
                </div>
            `;
            if(isDemo) {
                 headerArea.innerHTML += `<div class="mt-6 p-3 bg-yellow-50 text-yellow-700 text-sm rounded-lg border border-yellow-200 inline-block">Demo Mode: Showing English body for ${data.name}</div>`;
            }

            // 3. Render Body (The "Cardification" Process)
            contentArea.innerHTML = '';
            
            // Create a temporary div to parse the HTML string
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = bodyContent;
            
            let currentCard = null;
            let sectionCount = 0;

            Array.from(tempDiv.children).forEach(child => {
                if (child.tagName === 'H2') {
                    // Start new card
                    sectionCount++;
                    const anchorId = `section-${sectionCount}`;
                    
                    currentCard = document.createElement('section');
                    currentCard.id = anchorId;
                    currentCard.className = "bg-white p-6 md:p-8 rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-gray-100 transition-all hover:shadow-lg";
                    
                    // Style H2
                    child.className = "text-xl md:text-2xl font-bold text-gray-900 mb-6 pb-4 border-b border-gray-100 flex items-center";
                    // Add number badge styling if needed, or just keep text
                    
                    currentCard.appendChild(child);
                    contentArea.appendChild(currentCard);
                } else if (currentCard) {
                    // Style content inside card
                    if (child.tagName === 'P') {
                        child.className = "text-gray-600 leading-relaxed mb-4 text-base md:text-lg";
                    }
                    if (child.tagName === 'UL') {
                        child.className = "list-none space-y-3 mb-6 bg-gray-50 p-5 rounded-xl border border-gray-100";
                        // Add icons to list items via JS
                        Array.from(child.children).forEach(li => {
                            li.className = "relative pl-6 text-gray-700 leading-relaxed";
                            li.innerHTML = `<i class="fas fa-check text-indigo-500 absolute left-0 top-1.5 text-xs"></i><span>${li.innerHTML}</span>`;
                        });
                    }
                    currentCard.appendChild(child);
                } else {
                    // Orphan content (intro without H2)
                    if (!currentCard) {
                        currentCard = document.createElement('div');
                        currentCard.className = "bg-white p-6 rounded-2xl shadow-sm mb-6";
                        contentArea.appendChild(currentCard);
                    }
                    currentCard.appendChild(child);
                }
            });

            // 4. Generate Table of Contents
            generateTOC(data.tocTitle || "Contents");
            
            // Re-trigger fade
            contentArea.classList.remove('fade-in');
            void contentArea.offsetWidth;
            contentArea.classList.add('fade-in');
            
            langDropdown.classList.add('hidden');
        }

        function generateTOC(title) {
            tocContainer.innerHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-3">${title}</h3>`;
            const sections = contentArea.querySelectorAll('section h2');
            
            sections.forEach((h2) => {
                const sectionId = h2.parentElement.id;
                const link = document.createElement('a');
                link.href = `#${sectionId}`;
                // Clean text (remove numbering for cleaner look if desired, but legal needs numbers)
                link.innerText = h2.innerText; 
                link.className = "block py-2 pl-3 pr-4 text-sm text-gray-500 border-l-2 border-transparent hover:text-indigo-600 hover:bg-gray-50 hover:border-gray-300 transition-all rounded-r-md truncate";
                
                // Smooth scroll intercept
                link.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Set active state manually
                    document.querySelectorAll('#toc-desktop a').forEach(a => a.classList.remove('toc-active'));
                    link.classList.add('toc-active');
                };

                tocContainer.appendChild(link);
            });
        }

        // --- 3. Intersection Observer for TOC ---
        // Highlights the sidebar link as you scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    document.querySelectorAll('#toc-desktop a').forEach(link => {
                        link.classList.remove('toc-active');
                        if (link.getAttribute('href') === `#${id}`) {
                            link.classList.add('toc-active');
                        }
                    });
                }
            });
        }, { rootMargin: '-20% 0px -70% 0px' }); // Trigger when section is near top

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check scroll updates after rendering
            const config = { childList: true, subtree: true };
            const callback = function(mutationsList, observer) {
                const sections = document.querySelectorAll('section');
                sections.forEach(s => window.observer.observe(s)); // Use global obs
            };
            const obs = new MutationObserver(callback);
            obs.observe(contentArea, config);
            window.observer = observer;

            // Initial Load
            let userLang = navigator.language || navigator.userLanguage; 
            if (userLang.startsWith('zh')) userLang = 'zh'; // Simplify zh
            else userLang = userLang.split('-')[0];
            
            setLanguage(userLang);
        });

    </script>
</body>
</html>
